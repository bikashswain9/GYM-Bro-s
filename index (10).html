<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Subscription Tracker with Login</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      color: #f0f0f0;
    }
    .hidden { display: none; }
    .login-box {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .login-form {
      background: rgba(255,255,255,0.1);
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      width: 300px;
    }
    .login-form input, .login-form button {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
      border: none;
      border-radius: 5px;
    }
    .login-form button {
      background: #2a5298;
      color: white;
      cursor: pointer;
    }

    #app { padding: 20px; }
    h2 { text-align: center; }
    .summary-boxes {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    .box {
      background: #1e3c72;
      padding: 10px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      text-align: center;
      cursor: pointer;
      color: #fff;
      font-weight: bold;
      transition: 0.2s ease-in-out;
    }
    .box:hover { transform: scale(1.05); background: #2a5298; }
    .notification-badge {
      background: red; color: white; border-radius: 50%;
      padding: 2px 6px; font-size: 12px; margin-left: 5px;
    }
    table {
      width: 100%; border-collapse: collapse;
      margin-top: 20px; background: #ffffff;
      color: #333; border-radius: 10px;
    }
    th, td {
      border: 1px solid #ccc; padding: 10px;
      text-align: center;
    }
    .active { background-color: #d4edda; color: #155724; }
    .expired { background-color: #f8d7da; color: #721c24; }
    .soon { background-color: #fff3cd; color: #856404; }
    input, select { padding: 5px; margin: 5px; }
    .form-section {
      background: #ffffff; padding: 20px;
      border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      color: #333; margin-top: 20px;
    }
    .input-group {
      display: flex; flex-wrap: wrap; gap: 10px;
    }
    button.edit, button.delete {
      margin: 2px; padding: 4px 10px;
    }
    #searchBar {
      margin-top: 20px; padding: 10px;
      width: 100%; max-width: 400px;
      margin-left: auto; margin-right: auto; display: block;
    }
    @media(max-width: 600px) {
      .input-group { flex-direction: column; }
      table { display: block; overflow-x: auto; }
    }
  </style>
</head>
<body>

  <!-- Login UI -->
  <div id="loginBox" class="login-box">
    <div class="login-form">
      <h2>üîê Login</h2>
      <input type="text" id="username" placeholder="Username" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <p id="error" style="color: red;"></p>
    </div>
  </div>

  <!-- App UI -->
  <div id="app" class="hidden">
    <h2>üìã Subscription Tracker</h2>
    <input type="text" id="searchBar" placeholder="Search by name, contact, or category..." onkeyup="filterTable()">

    <div class="summary-boxes">
      <div class="box" onclick="filterByType('pt')">PT Clients: <span id="ptCount">0</span></div>
      <div class="box" onclick="filterByType('normal')">Normal Clients: <span id="normalCount">0</span></div>
      <div class="box" onclick="filterByType('all')">All Clients: <span id="allCount">0</span></div>
      <div class="box" onclick="filterByType('active')">Active: <span id="activeCount">0</span></div>
      <div class="box" onclick="filterByType('expired')">Expired: <span id="expiredCount">0</span></div>
      <div class="box" onclick="filterByType('soon10')">10 Days Left <span class="notification-badge" id="soon10">0</span></div>
      <div class="box" onclick="filterByType('soon5')">5 Days Left <span class="notification-badge" id="soon5">0</span></div>
      <button onclick="exportToCSV()">üì§ Export to CSV</button>
    </div>

    <div class="form-section">
      <h3 id="form-title">Add New Member</h3>
      <div class="input-group">
        <input type="text" id="name" placeholder="Name">
        <select id="category">
          <option value="">Select Category</option>
          <option value="PT">PT</option>
          <option value="Normal">Normal</option>
        </select>
        <input type="text" id="contact" placeholder="Contact No" maxlength="10" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        <input type="date" id="start">
        <input type="date" id="renewal">
        <input type="text" id="billing" placeholder="Billing Cycle">
        <input type="number" id="amount" placeholder="Amount ‚Çπ">
        <input type="text" id="notes" placeholder="Notes (optional)">
        <button onclick="submitForm()" id="submitBtn">Add Member</button>
      </div>
    </div>

    <table id="crmTable">
      <thead>
        <tr>
          <th>Name</th><th>Category</th><th>Contact No</th>
          <th>Start Date</th><th>Renewal Date</th>
          <th>Billing Cycle</th><th>Amount</th>
          <th>Status</th><th>Days Left</th><th>Notes</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Script Section -->
  <script>
    const validUser = "admin";
    const validPass = "1234";

    function login() {
      const user = document.getElementById("username").value;
      const pass = document.getElementById("password").value;
      if (user === validUser && pass === validPass) {
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("app").classList.remove("hidden");
        renderTable();
      } else {
        document.getElementById("error").innerText = "Invalid username or password!";
      }
    }

    let editIndex = -1;
    let data = JSON.parse(localStorage.getItem("crmData")) || [];

    function calculateDaysLeft(date) {
      const today = new Date();
      const d = new Date(date);
      return Math.floor((d - today) / (1000 * 60 * 60 * 24));
    }

    function getStatusText(days) {
      return days < 0 ? "Expired" : "Active";
    }

    function getStatusClass(days) {
      if (days < 0) return "expired";
      if (days <= 10) return "soon";
      return "active";
    }

    function submitForm() {
      const entry = {
        name: name.value, category: category.value, contact: contact.value,
        start: start.value, renewal: renewal.value, billing: billing.value,
        amount: amount.value, notes: notes.value
      };
      if (!entry.name || !entry.category || !entry.contact || !entry.start || !entry.renewal) {
        alert("Fill all required fields.");
        return;
      }
      if (editIndex === -1) data.push(entry);
      else {
        data[editIndex] = entry;
        editIndex = -1;
        submitBtn.innerText = "Add Member";
        formTitle.innerText = "Add New Member";
      }
      saveAndRender(); clearForm();
    }

    function renderTable() {
      const tbody = document.querySelector("#crmTable tbody");
      tbody.innerHTML = "";
      let all = 0, active = 0, expired = 0, soon5 = 0, soon10 = 0, pt = 0, normal = 0;
      data.forEach((item, index) => {
        const days = calculateDaysLeft(item.renewal);
        const status = getStatusText(days);
        const className = getStatusClass(days);
        if (item.category.toLowerCase() === "pt") pt++; else normal++;
        if (status === "Active") active++; else expired++;
        if (days <= 10 && days >= 6) soon10++;
        if (days <= 5 && days >= 0) soon5++;
        all++;

        tbody.innerHTML += `<tr>
          <td>${item.name}</td><td>${item.category}</td>
          <td><a href="tel:${item.contact}">${item.contact}</a></td>
          <td>${item.start}</td><td>${item.renewal}</td><td>${item.billing}</td>
          <td>‚Çπ${item.amount}</td><td class="${className}">${status}</td>
          <td>${days}</td><td>${item.notes || "-"}</td>
          <td><button class="edit" onclick="editRow(${index})">Edit</button>
              <button class="delete" onclick="deleteRow(${index})">Delete</button></td></tr>`;
      });

      ptCount.innerText = pt;
      normalCount.innerText = normal;
      allCount.innerText = all;
      activeCount.innerText = active;
      expiredCount.innerText = expired;
      soon5.innerText = soon5;
      soon10.innerText = soon10;
    }

    function saveAndRender() {
      localStorage.setItem("crmData", JSON.stringify(data));
      renderTable();
    }

    function clearForm() {
      name.value = category.value = contact.value = start.value = renewal.value = billing.value = amount.value = notes.value = "";
    }

    function editRow(i) {
      const item = data[i];
      name.value = item.name; category.value = item.category; contact.value = item.contact;
      start.value = item.start; renewal.value = item.renewal; billing.value = item.billing;
      amount.value = item.amount; notes.value = item.notes || "";
      editIndex = i; submitBtn.innerText = "Update Member"; formTitle.innerText = "Edit Member";
    }

    function deleteRow(i) {
      if (confirm("Delete this entry?")) {
        data.splice(i, 1); saveAndRender();
      }
    }

    function filterByType(type) {
      const rows = document.querySelectorAll("#crmTable tbody tr");
      rows.forEach(row => {
        const days = parseInt(row.cells[8].innerText);
        const status = row.cells[7].innerText.toLowerCase();
        const cat = row.cells[1].innerText.toLowerCase();
        let show = false;
        if (type === 'all') show = true;
        if (type === 'active' && status === 'active') show = true;
        if (type === 'expired' && status === 'expired') show = true;
        if (type === 'soon10' && days <= 10 && days >= 6) show = true;
        if (type === 'soon5' && days <= 5 && days >= 0) show = true;
        if (type === 'pt' && cat === 'pt') show = true;
        if (type === 'normal' && cat !== 'pt') show = true;
        row.style.display = show ? '' : 'none';
      });
    }

    function filterTable() {
      const q = searchBar.value.toLowerCase();
      document.querySelectorAll("#crmTable tbody tr").forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(q) ? "" : "none";
      });
    }

    function exportToCSV() {
      const csv = [["Name","Category","Contact","Start","Renewal","Billing","Amount","Status","Days Left","Notes"]];
      data.forEach(item => {
        const days = calculateDaysLeft(item.renewal);
        const status = getStatusText(days);
        csv.push([item.name, item.category, item.contact, item.start, item.renewal, item.billing, `‚Çπ${item.amount}`, status, days, item.notes || ""]);
      });
      const csvContent = csv.map(e => e.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "subscriptions.csv";
      link.click();
    }
  </script>
</body>
</html>
